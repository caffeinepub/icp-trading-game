{
  "kind": "build_request",
  "title": "Fix user registration check during ICP purchase",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix the registration verification logic in the buy ICP flow to correctly recognize registered users and allow them to proceed with purchasing ICP without showing 'user not registered' errors",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Still says user not registered when I go to buy ICP. Please fix"
        ]
      },
      "acceptanceCriteria": [
        "A registered user can successfully initiate an ICP purchase without encountering 'user not registered' errors",
        "The backend buyICP function correctly validates user registration status before processing the transaction",
        "Registration state persists correctly across the user session"
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure the frontend trading panel correctly handles the registration check response and displays appropriate error messages only when a user is genuinely not registered",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Still says user not registered when I go to buy ICP"
        ]
      },
      "acceptanceCriteria": [
        "The trading panel's buy ICP action properly parses backend registration errors",
        "Users who have completed registration see no 'user not registered' errors when attempting to buy ICP",
        "Clear error messages are shown only for genuinely unregistered users"
      ]
    }
  ],
  "constraints": [
    "Do not modify the registration form or registration success components",
    "Preserve the existing Internet Identity authentication flow",
    "Maintain the current account data structure in the backend"
  ],
  "nonGoals": [
    "Changing the registration UI or workflow",
    "Modifying the portfolio display logic",
    "Adding new trading features beyond fixing the registration check"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}